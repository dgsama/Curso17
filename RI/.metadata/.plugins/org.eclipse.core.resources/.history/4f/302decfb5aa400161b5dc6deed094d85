package uo.ri.ui.cash.action;

import java.sql.*;

import alb.util.console.Console;
import alb.util.jdbc.Jdbc;
import alb.util.menu.Action;
import uo.ri.common.BusinessException;

public class ReparacionesNoFacturadasUnClienteAction implements Action {

	/**
	 * Proceso:
	 * 
	 * - Pide el DNI del cliente
	 * 
	 * - Muestra en pantalla todas sus averias no facturadas (status <>
	 * 'FACTURADA'). De cada avería muestra su id, fecha, status, importe y
	 * descripción
	 */

	private static String query = "select id, importe, status, factura_id from TAVERIAS where STATUS != 'FACTURADA'";
	private static String queryUpdate = "UPDATE TAVERIAS SET STATUS='FACTURADA' WHERE id = ?";

	@Override
	public void execute() throws BusinessException, SQLException {
		Console.println("\nListado de averías no facturadas\n");

		Connection c = null;
		PreparedStatement pst = null;
		ResultSet rs = null;

		double importe = 0;
		double iva = 21;

		c = Jdbc.getConnection();

		pst = c.prepareStatement(query);

		rs = pst.executeQuery();
		while (rs.next()) {
			Console.printf("\t%d\n", rs.getLong(1));
			if (rs.getString("STATUS") == "TERMINADA") {
				importe += rs.getLong("IMPORTE") + (rs.getLong("IMPORTE") * iva * 0.01);

				PreparedStatement pstUpd = c.prepareStatement(queryUpdate);
				pstUpd.setLong(1, rs.getLong(1));
				pstUpd.executeUpdate();
			}
		}

		java.sql.Date sqlDate = new java.sql.Date(new java.util.Date().getTime());

		String SQL1 = "insert into TFACTURAS(id, fecha, importe, iva, numero, status) values (?,?,?,?,?,?)";

		PreparedStatement pst1 = c.prepareStatement(SQL1);
		pst.setLong(1, 1970);
		pst.setDate(2, sqlDate);
		pst.setDouble(3, importe);
		pst.setDouble(4, iva);
		pst.setDouble(5, 648);
		pst.setString(6, "ABONADA");
		pst.execute();

		pst1.close();

		Jdbc.close(rs, pst, c);

	}

}
